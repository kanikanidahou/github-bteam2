<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.1, maximum-scale=4, user-scalable=yes">
<!-- quaggaJSの読み込み -->
<script src="./quagga.min.js"></script>
<script>
var DetectedCount = 0, DetectedCode = "";
var video, tmp, tmp_ctx, jan, prev, prev_ctx, w, h, mw, mh, x1, y1;

window.addEventListener('load', function(event) {
  video = document.createElement('video');
  video.setAttribute("autoplay", "");
  video.setAttribute("muted", "");
  video.setAttribute("playsinline", "");
  video.onloadedmetadata = function(e) { video.play(); };
  
  prev = document.getElementById("preview");
  prev_ctx = prev.getContext("2d", { willReadFrequently: true });
  tmp = document.createElement('canvas');
  tmp_ctx = tmp.getContext("2d", { willReadFrequently: true });
  
  jan = document.getElementById("ISBN");

  // カメラ使用の許可ダイアログが表示される
  navigator.mediaDevices.getUserMedia(
    { "audio": false, "video": { "facingMode": "environment", "width": { "ideal": 640 }, "height": { "ideal": 480 } } }
  ).then(
    function(stream) {
      video.srcObject = stream;
      // 0.5秒毎にスキャンする
      setTimeout(Scan, 500, true);
    }
  ).catch(
    function(err) { console.error(err); }
  );

  function Scan(first) {
    if (first) {
      // 選択された幅高さ
      w = video.videoWidth;
      h = video.videoHeight;
      // 画面上の表示サイズ
      prev.style.width = (w / 2) + "px";
      prev.style.height = (h / 2) + "px";
      // 内部のサイズ
      prev.setAttribute("width", w);
      prev.setAttribute("height", h);
      mw = w * 0.5;
      mh = h * 0.2;
      x1 = (w - mw) / 2;
      y1 = (h - mh) / 2;
    }
    prev_ctx.drawImage(video, 0, 0, w, h);
    prev_ctx.beginPath();
    prev_ctx.strokeStyle = "rgb(255,0,0)";
    prev_ctx.lineWidth = 2;
    prev_ctx.rect(x1, y1, mw, mh);
    prev_ctx.stroke();
    tmp.setAttribute("width", mw);
    tmp.setAttribute("height", mh);
    tmp_ctx.drawImage(prev, x1, y1, mw, mh, 0, 0, mw, mh);
    tmp.toBlob(function(blob) {
      let reader = new FileReader();
      reader.onload = function() {
        let config = {
          decoder: {
            readers: ["ean_reader", "ean_8_reader"],
            multiple: false // 同時に複数のバーコードを解析しない
          },
          locator: { patchSize: "large", halfSample: false },
          locate: false,
          src: reader.result
        };
        Quagga.decodeSingle(config, function(result) {
          if (result && result.codeResult) {
            // 読み取り誤差が多いため、3回連続で同じ値だった場合に成功とする
            if (DetectedCode == result.codeResult.code) {
              DetectedCount++;
            } else {
              DetectedCount = 0;
              DetectedCode = result.codeResult.code;
            }
            if (DetectedCount >= 3) {
              jan.value = result.codeResult.code;
              DetectedCode = '';
              DetectedCount = 0;
              console.log("Detected Code: " + result.codeResult.code); // デバッグ用
            }
          }
        });
      }
      reader.readAsDataURL(blob);
    });
    setTimeout(Scan, 50, false);
  }
});

function sendToNotion() {
  const notionToken = 'secret_lruJvyFNd3aRm8HD5qmZX5JfKeqQdYaGCTxb5lP1z4E'; // NotionのAPIトークン
  const databaseId = '2517262d6cc0429797696292c1e83583'; // NotionのデータベースID

  const isbn = document.getElementById("ISBN").value;
  const title = document.getElementById("title").value;
  const subtitle = document.getElementById("subtitle").value;
  const authors = document.getElementById("authors").value;
  const publishedDate = document.getElementById("publishedDate").value;
  const pageCount = document.getElementById("pageCount").value;
  const imageSrc = document.getElementById("imageSrc").value;

  const data = {
    parent: { database_id: databaseId },
    properties: {
      Title: {
        title: [
          {
            text: {
              content: title
            }
          }
        ]
      },
      ISBN: {
        rich_text: [
          {
            text: {
              content: isbn
            }
          }
        ]
      },
      Subtitle: {
        rich_text: [
          {
            text: {
              content: subtitle
            }
          }
        ]
      },
      Authors: {
        rich_text: [
          {
            text: {
              content: authors
            }
          }
        ]
      },
      PublishedDate: {
        rich_text: [
          {
            text: {
              content: publishedDate
            }
          }
        ]
      },
      PageCount: {
        rich_text: [
          {
            text: {
              content: pageCount
            }
          }
        ]
      },
      Image: {
        url: imageSrc
      }
    }
  };

  fetch('https://api.notion.com/v1/pages', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${notionToken}`,
      'Content-Type': 'application/json',
      'Notion-Version': '2022-06-28' // または最新のNotion APIバージョン
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    console.log('Success:', data);
  })
  .catch((error) => {
    console.error('Error:', error);
  });
}
</script>
</head>
<body>
  <div><canvas id="preview"></canvas></div>
  <form method="post" name="form" target="dummy">
    <fieldset>
      <div class="container">
        <div class="row">
          <div class="col-lg-8">
            <h3 class="mt-5">
              Send To Notion<br>
              <small class="text-muted">本のバーコードを読んでNotionに追加</small>
            </h3>
            <label class="col-form-label" for="ISBN">ISBN:</label>
            <!-- quaggaJSでバーコードから読み取ったISBNがここに入力される -->
            <input type="text" name="isbn" id="ISBN" class="form-control"><br>
            <button type="button" onclick="sendToNotion();" class="btn btn-primary">Notionに送信</button><br>
            <img src="" id="imagePlace"><br>
            <label class="col-form-label" for="imageSrc">画像URL</label>
            <!-- 画像URLを取得したらsrcを設定する -->
            <input type="text" name="imageSrc" id="imageSrc" class="form-control"><br>
            <label class="col-form-label" for="title">タイトル</label>
            <input type="text" name="title" id="title" class="form-control"><br>
            <label class="col-form-label" for="subtitle">サブタイトル</label>
            <input type="text" name="subtitle" id="subtitle" class="form-control"><br>
            <label class="col-form-label" for="authors">著者</label>
            <input type="text" name="authors
